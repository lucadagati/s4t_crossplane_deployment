openapi: 3.0.3
info:
  title: Stack4Things/IoTronic API
  description: |
    REST API for Stack4Things/IoTronic IoT resource management service.
    This API allows management of IoT boards, plugins, services, and related resources.
  version: 0.5.0
  contact:
    name: Stack4Things/IoTronic
    url: https://opendev.org/x/iotronic

servers:
  - url: http://iotronic-conductor:8812/v1
    description: Kubernetes internal service
  - url: http://localhost:8812/v1
    description: Local development

security:
  - KeystoneAuth: []

components:
  securitySchemes:
    KeystoneAuth:
      type: apiKey
      in: header
      name: X-Auth-Token
      description: Keystone authentication token

  schemas:
    Board:
      type: object
      required:
        - name
        - code
        - type
      properties:
        uuid:
          type: string
          format: uuid
          description: Unique identifier for the board
        name:
          type: string
          description: Human-readable name of the board
        code:
          type: string
          description: Unique code for board registration
        type:
          type: string
          enum: [virtual, physical]
          description: Type of board
        status:
          type: string
          enum: [registered, online, offline]
          description: Current status of the board
        location:
          type: array
          items:
            $ref: '#/components/schemas/Location'
        agent:
          type: string
          description: UUID of the wagent managing this board
        session:
          type: string
          description: WAMP session ID

    Location:
      type: object
      properties:
        latitude:
          type: string
          description: Latitude coordinate
        longitude:
          type: string
          description: Longitude coordinate
        altitude:
          type: string
          description: Altitude coordinate

    Plugin:
      type: object
      required:
        - name
        - code
      properties:
        uuid:
          type: string
          format: uuid
          description: Unique identifier for the plugin
        name:
          type: string
          description: Name of the plugin
        code:
          type: string
          description: Python code for the plugin
        parameters:
          type: object
          additionalProperties: true
          description: Plugin parameters as key-value pairs
        version:
          type: string
          description: Plugin version

    PluginInjection:
      type: object
      properties:
        plugin:
          type: string
          format: uuid
          description: UUID of the injected plugin
        status:
          type: string
          enum: [injected, running, stopped]
          description: Status of the plugin injection
        onboot:
          type: boolean
          description: Whether plugin starts on boot
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
          nullable: true

    Service:
      type: object
      required:
        - name
        - port
        - protocol
      properties:
        uuid:
          type: string
          format: uuid
        name:
          type: string
        port:
          type: integer
          minimum: 1
          maximum: 65535
        protocol:
          type: string
          enum: [TCP, UDP]
        project:
          type: string

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            message:
              type: string
            code:
              type: string

paths:
  /boards:
    get:
      summary: List all boards
      tags:
        - Boards
      responses:
        '200':
          description: List of boards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Board'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create a new board
      tags:
        - Boards
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - code
                - type
              properties:
                name:
                  type: string
                code:
                  type: string
                type:
                  type: string
                  enum: [virtual, physical]
                location:
                  type: array
                  items:
                    $ref: '#/components/schemas/Location'
      responses:
        '201':
          description: Board created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Board'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /boards/{uuid}:
    get:
      summary: Get board details
      tags:
        - Boards
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Board details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Board'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      summary: Update board
      tags:
        - Boards
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                status:
                  type: string
                location:
                  type: array
                  items:
                    $ref: '#/components/schemas/Location'
      responses:
        '200':
          description: Board updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Board'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      summary: Delete board
      tags:
        - Boards
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Board deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /boards/{board_uuid}/plugins:
    get:
      summary: Get injected plugins for a board
      tags:
        - Plugin Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of injected plugins
          content:
            application/json:
              schema:
                type: object
                properties:
                  injections:
                    type: array
                    items:
                      $ref: '#/components/schemas/PluginInjection'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      summary: Inject a plugin into a board
      tags:
        - Plugin Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - plugin
              properties:
                plugin:
                  type: string
                  format: uuid
                  description: UUID of the plugin to inject
      responses:
        '200':
          description: Plugin injected successfully
          content:
            text/plain:
              schema:
                type: string
                example: "PluginInject result: INJECTED"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'
      description: |
        Injects a plugin into a board. The board must be **online** (Lightning Rod connected)
        for the injection to succeed and persist in the database.

  /boards/{board_uuid}/plugins/{plugin_uuid}:
    delete:
      summary: Remove injected plugin from board
      tags:
        - Plugin Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: plugin_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Plugin removed
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Perform action on injected plugin
      tags:
        - Plugin Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: plugin_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [start, stop, restart]
      responses:
        '200':
          description: Action performed
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plugins:
    get:
      summary: List all plugins
      tags:
        - Plugins
      responses:
        '200':
          description: List of plugins
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Plugin'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create a new plugin
      tags:
        - Plugins
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - code
              properties:
                name:
                  type: string
                code:
                  type: string
                  description: Python code for the plugin
                parameters:
                  type: object
                  additionalProperties: true
      responses:
        '201':
          description: Plugin created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Plugin'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /plugins/{uuid}:
    get:
      summary: Get plugin details
      tags:
        - Plugins
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Plugin details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Plugin'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      summary: Update plugin
      tags:
        - Plugins
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                code:
                  type: string
                parameters:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Plugin updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Plugin'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      summary: Delete plugin
      tags:
        - Plugins
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Plugin deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /services:
    get:
      summary: List all services
      tags:
        - Services
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create a new service
      tags:
        - Services
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - port
                - protocol
              properties:
                name:
                  type: string
                port:
                  type: integer
                  minimum: 1
                  maximum: 65535
                protocol:
                  type: string
                  enum: [TCP, UDP]
                project:
                  type: string
      responses:
        '201':
          description: Service created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /services/{uuid}:
    get:
      summary: Get service details
      tags:
        - Services
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Service details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      summary: Update service
      tags:
        - Services
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                port:
                  type: integer
                protocol:
                  type: string
                  enum: [TCP, UDP]
      responses:
        '200':
          description: Service updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      summary: Delete service
      tags:
        - Services
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Service deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /boards/{board_uuid}/services:
    get:
      summary: Get exposed services for a board
      tags:
        - Service Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of exposed services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      summary: Expose a service on a board
      tags:
        - Service Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - service
              properties:
                service:
                  type: string
                  format: uuid
                  description: UUID of the service to expose
      responses:
        '200':
          description: Service exposed successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /boards/{board_uuid}/services/{service_uuid}:
    delete:
      summary: Remove exposed service from board
      tags:
        - Service Injection
      parameters:
        - name: board_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: service_uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Service removed
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

tags:
  - name: Boards
    description: Board (device) management operations
  - name: Plugins
    description: Plugin management operations
  - name: Plugin Injection
    description: Plugin injection and management on boards
  - name: Services
    description: Service management operations
  - name: Service Injection
    description: Service exposure and management on boards
