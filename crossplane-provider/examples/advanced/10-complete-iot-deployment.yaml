---
# Esempio Avanzato: Deployment Completo IoT
# Questo esempio mostra un deployment completo di un'applicazione IoT
# che include plugin, service, webservice e le relative injection
#
# Scenario: Sistema di monitoraggio IoT con:
# - Plugin per raccolta dati
# - Service per comunicazione
# - Webservice per API esterna
# - Injection su board di produzione
#
# IMPORTANTE: Sostituire tutti i placeholder con valori reali prima di applicare

---
# ============================================
# STEP 1: Creazione Plugin
# ============================================

apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: Plugin
metadata:
  name: iot-data-collector-plugin
  labels:
    app: iot-monitoring
    component: plugin
    version: "1.0.0"
spec:
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
  forProvider:
    name: "IoT Data Collector Plugin"
    version: "1.0.0"
    code: |
      #!/bin/bash
      # Plugin per raccolta dati IoT
      # Raccoglie dati da sensori e li invia a Stack4Things
      
      SENSOR_DATA="/tmp/sensor_data.json"
      API_ENDPOINT="http://localhost:8812/api/v1/data"
      
      # Simula lettura sensore
      TEMP=$(cat /sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo "25000")
      HUMIDITY=$(shuf -i 40-80 -n 1)
      PRESSURE=$(shuf -i 980-1020 -n 1)
      
      # Crea payload JSON
      cat > "$SENSOR_DATA" <<EOF
      {
        "timestamp": $(date +%s),
        "temperature": $((TEMP/1000)),
        "humidity": $HUMIDITY,
        "pressure": $PRESSURE,
        "board": "$(hostname)"
      }
      EOF
      
      # Invia dati
      curl -X POST "$API_ENDPOINT" \
        -H "Content-Type: application/json" \
        -d @"$SENSOR_DATA" \
        -s -o /dev/null
      
      echo "Data collected and sent"
    parameters:
      collectionInterval: "60"
      apiEndpoint: "http://localhost:8812/api/v1/data"
      enableLogging: "true"

---
# ============================================
# STEP 2: Creazione Service
# ============================================

apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: Service
metadata:
  name: iot-communication-service
  labels:
    app: iot-monitoring
    component: service
spec:
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
  forProvider:
    name: "IoT Communication Service"
    project: "admin"
    port: 5000
    protocol: "TCP"

---
# ============================================
# STEP 3: Creazione Webservice
# ============================================

apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: Webservice
metadata:
  name: iot-api-webservice
  labels:
    app: iot-monitoring
    component: webservice
spec:
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
  forProvider:
    name: "IoT API Webservice"
    port: 8080
    boardUuid: "BOARD_UUID_HERE"  # Sostituire con UUID reale
    secure: false
    extra:
      description: "API REST per accesso ai dati IoT"
      version: "1.0.0"
      endpoints:
        - "/api/v1/data"
        - "/api/v1/status"
        - "/api/v1/health"

---
# ============================================
# STEP 4: Injection Plugin su Board
# ============================================
# NOTA: Dopo aver creato il plugin, ottenere l'UUID dal status:
# kubectl get plugin iot-data-collector-plugin -o jsonpath='{.status.atProvider.uuid}'
# Sostituire PLUGIN_UUID_HERE con l'UUID ottenuto

apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: BoardPluginInjection
metadata:
  name: iot-data-collector-injection
  labels:
    app: iot-monitoring
    component: injection
    type: plugin
spec:
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
  forProvider:
    boardUuid: "BOARD_UUID_HERE"  # Sostituire con UUID reale
    pluginUuid: "PLUGIN_UUID_HERE"  # Sostituire con UUID del plugin creato

---
# ============================================
# STEP 5: Injection Service su Board
# ============================================
# NOTA: Dopo aver creato il service, ottenere l'UUID dal status:
# kubectl get service iot-communication-service -o jsonpath='{.status.atProvider.uuid}'
# Sostituire SERVICE_UUID_HERE con l'UUID ottenuto

apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: BoardServiceInjection
metadata:
  name: iot-communication-injection
  labels:
    app: iot-monitoring
    component: injection
    type: service
spec:
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
  forProvider:
    boardUuid: "BOARD_UUID_HERE"  # Sostituire con UUID reale
    serviceUuid: "SERVICE_UUID_HERE"  # Sostituire con UUID del service creato

---
# ============================================
# ISTRUZIONI PER L'UTILIZZO
# ============================================
#
# 1. Verificare che il ProviderConfig sia configurato:
#    kubectl get providerconfig s4t-provider-domain
#
# 2. Applicare il deployment (in ordine):
#    kubectl apply -f examples/advanced/10-complete-iot-deployment.yaml
#
# 3. Attendere la creazione delle risorse base (Plugin, Service, Webservice):
#    kubectl get plugin,service,webservice
#
# 4. Ottenere gli UUID dalle risorse create:
#    kubectl get plugin iot-data-collector-plugin -o jsonpath='{.status.atProvider.uuid}' && echo
#    kubectl get service iot-communication-service -o jsonpath='{.status.atProvider.uuid}' && echo
#
# 5. Aggiornare i file YAML con gli UUID ottenuti:
#    - Sostituire PLUGIN_UUID_HERE nell'injection del plugin
#    - Sostituire SERVICE_UUID_HERE nell'injection del service
#    - Sostituire BOARD_UUID_HERE con l'UUID del board reale
#
# 6. Applicare nuovamente le injection:
#    kubectl apply -f examples/advanced/10-complete-iot-deployment.yaml
#
# 7. Verificare lo stato di tutte le risorse:
#    kubectl get plugin,service,webservice,boardplugininjection,boardserviceinjection
#
# 8. Monitorare i log del provider per eventuali errori:
#    kubectl logs -n crossplane-system -l pkg.crossplane.io/provider=s4t-iot --tail=100
#
# 9. Verificare lo stato di sincronizzazione:
#    kubectl get plugin,service,webservice,boardplugininjection,boardserviceinjection \
#      -o jsonpath='{range .items[*]}{.kind}/{.metadata.name}: Ready={.status.conditions[?(@.type=="Ready")].status} Synced={.status.conditions[?(@.type=="Synced")].status}{"\n"}{end}'
#
# 10. Per cleanup:
#     kubectl delete -f examples/advanced/10-complete-iot-deployment.yaml

