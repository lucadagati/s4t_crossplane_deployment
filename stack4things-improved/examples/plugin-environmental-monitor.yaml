apiVersion: iot.s4t.crossplane.io/v1alpha1
kind: Plugin
metadata:
  name: environmental-monitor
  namespace: default
spec:
  forProvider:
    name: "Environmental Monitor"
    code: |
      from iotronic_lightningrod.modules.plugins import Plugin
      from oslo_log import log as logging
      import time
      import random
      import json
      
      LOG = logging.getLogger(__name__)
      
      class Worker(Plugin.Plugin):
          def __init__(self, uuid, name, q_result=None, params=None):
              super(Worker, self).__init__(uuid, name, q_result, params)
              self.interval = int(params.get('interval', 30)) if params else 30
              self.data_count = 0
              
          def run(self):
              LOG.info(f"Environmental Monitor Plugin {self.name} started")
              LOG.info(f"Configuration: interval={self.interval}s, params={self.params}")
              
              try:
                  while self._is_running:
                      # Generate simulated environmental data
                      timestamp = time.time()
                      data = {
                          'timestamp': timestamp,
                          'temperature': round(18.0 + random.uniform(-2, 5), 1),
                          'humidity': round(75.0 + random.uniform(-10, 15), 1),
                          'pressure': round(1013.0 + random.uniform(-10, 10), 1),
                          'wind_speed': round(random.uniform(0, 10), 1),
                          'wind_direction': random.randint(0, 360)
                      }
                      
                      # Log structured data
                      LOG.info(f"Environmental Data #{self.data_count}: {json.dumps(data)}")
                      
                      # Log individual metrics
                      LOG.info(f"  Temperature: {data['temperature']}°C")
                      LOG.info(f"  Humidity: {data['humidity']}%")
                      LOG.info(f"  Pressure: {data['pressure']}hPa")
                      LOG.info(f"  Wind: {data['wind_speed']} m/s @ {data['wind_direction']}°")
                      
                      self.data_count += 1
                      time.sleep(self.interval)
                      
              except KeyboardInterrupt:
                  LOG.info("Plugin interrupted by user")
              except Exception as e:
                  LOG.error(f"Plugin error: {str(e)}")
                  if self.q_result:
                      self.q_result.put(f"ERROR: {str(e)}")
              finally:
                  LOG.info(f"Plugin {self.name} stopped after {self.data_count} data points")
                  if self.q_result:
                      self.q_result.put(f"Completed: {self.data_count} data points logged")
    parameters:
      interval: 30
      description: "Environmental monitoring plugin that logs simulated sensor data"
      location: "virtual"
  providerConfigRef:
    name: s4t-provider-domain
  deletionPolicy: Delete
